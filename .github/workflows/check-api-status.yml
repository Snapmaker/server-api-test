name: Check API and Notify on Failure

on:
  push:
    branches: ["main"]
  schedule:
    - cron: '0 * * * *'

jobs:
  check-api:
    runs-on: ubuntu-latest
    steps:
    - name: Get API List
      run: |
        # 使用 while 读取多行内容并逐行保存到数组
        apis=()
        while IFS= read -r line || [ -n "$line" ]; do
          apis+=("$line")
        done <<< "${{ secrets.NEED_CHECK_URLS }}"
        
        # 打印解析后的 API 列表
        for api in "${apis[@]}"; do
          echo "API: $api"
        done
    - name: Check APIs status
      id: check_status
      run: |
        for element in "${apis[@]}"; do
          echo "Accessing API with element ${element}"
          response=$(curl -o /dev/null -s -w "%{http_code}\n" "${element}")
          echo "response ${response}"
          echo "response $response"
          if [ "${response}" == "200" ]; then
            echo "HTTP状态码不等于200，发送通知..."
            curl -X POST \
              -H 'Content-Type: application/json' \
              -d '{
                "msg_type": "text",
                "content": {
                  "text": "${element}: API check failed. Status code: $response"
                }
              }' "${{ secrets.FEISHU_WEBHOOK }}"
          fi
        done
    # - name: Check API status
    #   id: check_status
    #   run: |
    #     status_code=$(curl -o /dev/null -s -w "%{http_code}\n" "${{ secrets.VERSIONS_URL}}")
    #     echo "Status code: $status_code"
    #     echo "::set-output name=status_code::$status_code"
      
    # - name: Send Feishu Notification if API check fails
    #   if: steps.check_status.outputs.status_code != '200'
    #   run: |
    #     curl -X POST \
    #       -H 'Content-Type: application/json' \
    #       -d '{
    #         "msg_type": "text",
    #         "content": {
    #           "text": "${{ secrets.VERSIONS_URL}}: API check failed. Status code: '${{ steps.check_status.outputs.status_code }}'"
    #         }
    #       }' "${{ secrets.FEISHU_WEBHOOK }}"

